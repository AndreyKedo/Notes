# Контейнеризация

**Контейнер** (Container) — стандартная единица ПО, в которую упаковывается приложение со всеми необходимыми для его полноценной работы зависимостями (кодом, средой запуска, библиотеками и настройками).

# Docker

## Архитектура Docker

*Docker* использует *клиент-серверную архитектуру*. 

Клиент и сервер общаются между собой при помощи REST API поверх сокетов и сетевого интерфейса.

**Docker-клиент** (Docker client) использует CLI-команды, чтобы общаться с *Docker daemon*, выступающим в роли *сервера*.
```js
/* примеры CLI-команд */
docker run
docker build
docker pull
```
**Docker daemon** собирает, запускает и раздаёт (distribute) контейнеры.

**Образ** (Image) - доступный только для чтения шаблон с инструкциями о том, как запустить какой-то Docker-контейнер. 

Один образ может расширять другой.

Для создания образа необходимо создать *Dockerfile* для определения шагов, необходимых для создания образа и запустить этот файл. Каждая инструкция в Dockerfile создаёт новый слой (layer) в образе. Когда Dockerfile изменяется и образ пересобирается (rebuild), пересобираются только изменённые слои.

Образы хранятся в Docker-реестре (Docker registry). Одним из таких является Docker Hub - публичный реестр, который используется по умолчанию.
```js
// загрузить image из реестра
docker pull <image>
// загрузить image в реестр
docker push <image>
```

**Контейнер** (Container) - запускаемый экземпляр образа. Его можно создавать, запускать, останавливать, перемещать и удалять при помощи Docker API или CLI.

По умолчанию контейнер достаточно хорошо изолирован от маширы-хоста, но это можно контролировать, передавая в контейнер всё необходимое.

## Хранение данных

## Volume

**Volume** - предпочитительный механизм для хранения данных (persisting data), используемых в Docker-контейнере.

Volume даёт контейнеру доступ к какой-то локальной папке на машине-хосте, на которой этот контейнер запущен. Файлы из Volume нельзя использовать на этапе сборки (build-time), то есть в Dockerfile нельзя использовать файлы из Volume, они доступны лишь во время выполнения (run-time).

### Почему следует использовать Volume

Volume хранится вне контейнера. Поэтому он не увеличивает размер контейнера, а также не подвержен влиянию жизненного цикла контейнера.


## Композиция контейнеров

**Docker Compose** - инструмент, позволяющий запускать приложения, состоящие из нескольких контейнеров.

Например, приложение имеет 3-tier архитектуру и состоит из клиента, сервера и бэкенда.
```yaml
version: '3.7'
services:
  mongo:
    command: mongod
    image: mongo:3.6.3
    ports:
      - "27017:27017" # map port to none standard port, to avoid conflicts with locally installed mongodb
    volumes:
      - /var/run/docker.sock:/var/run/docker.sockt
  client:
    build:
      context: "./client"
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
    ports:
      - "4000:4000"
  server:
    build:
      context: "./server"
      dockerfile: Dockerfile
    volumes: 
      - "./shared-folder:/app/shared-folder"
    ports:
      - "4001:4001"
```
